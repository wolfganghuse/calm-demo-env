{"status":{},"contains_secrets":true,"product_version":"3.2.0","spec":{"description":"","resources":{"client_attrs":{"b39046ae_deployment":{"y":261.5,"x":492}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"56af526b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"12936f8e_runbook","main_task_local_reference":{"kind":"app_task","name":"56af526b_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9592ed52_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"9ecea4dd_runbook","main_task_local_reference":{"kind":"app_task","name":"9592ed52_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5959c859_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3bc93e59_runbook","main_task_local_reference":{"kind":"app_task","name":"5959c859_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"b500460a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4a8e21e2_runbook","main_task_local_reference":{"kind":"app_task","name":"b500460a_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a88b201a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"15b440d5_runbook","main_task_local_reference":{"kind":"app_task","name":"a88b201a_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service1","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"CreateSnowUser"}],"name":"49a264dc_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CreateSnowUser","attrs":{"script":"headers = {\n        'Content-Type':'application\/json', \"Accept\" : \"application\/json\"\n}\nSnow_Instance = \"@@{Snow_Instance}@@\".split('\/\/')[-1].split('\/')[0]\nData={\"user_name\":\"nucalmuser\",\"first_name\":\"nucalmusr\",\"last_name\":\"nucalmusr\",\"title\":\"Administrative Assistant\",\"department\":\"Development\",\"user_password\":\"Snow@1234\",\"active\":\"true\",\"email\":\"xxx@xxx.com\",\"mobile_phone\":\"9999999987\"}\nurl = \"https:\/\/{}\/api\/now\/table\/sys_user?sysparm_input_display_value=true\".format(Snow_Instance)\nresp = urlreq(url, verb=\"POST\",params=json.dumps(Data),headers=headers,auth='BASIC', user=\"admin\", passwd=\"@@{AdminPassword}@@\", verify=False )\nprint(resp)\n\nData={\"user\":\"nucalmusr nucalmusr\",'role':'mid_server','state':\"active\"}\nurl = \"https:\/\/{}\/api\/now\/table\/sys_user_has_role\".format(Snow_Instance)\nresp = urlreq(url, verb=\"POST\",params=json.dumps(Data),headers=headers,auth='BASIC', user=\"admin\", passwd=\"@@{AdminPassword}@@\", verify=False )\nprint(resp)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"12893f56_runbook","main_task_local_reference":{"kind":"app_task","name":"49a264dc_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"93e413be_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a0734bb3_runbook","main_task_local_reference":{"kind":"app_task","name":"93e413be_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"VM1","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"Cred_OS"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"snowmid-@@{calm_array_index}@@-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"64cf3bea-fc2f-4827-9ef6-fd1bce2ef86f"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nhostname: @@{name}@@\nusers:\n  - name: @@{Cred_OS.username}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nchpasswd:\n  list: |\n    @@{Cred_OS.username}@@:@@{Cred_OS.secret}@@\n  expire: False\nssh_pwauth: True"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"8c4f7de3-544f-426d-98a2-40986fb657e4","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"CENTOS7","uuid":"ede1e3ef-bae3-4ed2-908b-5c85d149ab00"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"vMNvgD05NDVP\/lgDHXUqrq5cVc099TDUEVgC5bfyZmu9d4llb0c=:utf-8"},"name":"Cred_OS"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service1"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"InstallSelenium"},{"kind":"app_task","name":"DownloadMidServer"}],"name":"ff04da96_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"InstallSelenium"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"DownloadMidServer"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"InstallSelenium","attrs":{"exit_status":[],"script":"sudo yum install -y python3\nsudo pip3 install selenium\n\nsudo yum install -y firefox \nsudo yum install -y wget unzip zip\nsudo yum install -y  glibc.i686\nwget https:\/\/github.com\/mozilla\/geckodriver\/releases\/download\/v0.26.0\/geckodriver-v0.26.0-linux64.tar.gz\ntar -xvzf geckodriver-v0.26.0-linux64.tar.gz\nsudo cp geckodriver \/usr\/local\/bin\/geckodriver\n\n#echo \"JAVA_HOME=\/usr\/lib\/jvm\/jre-1.8.0-openjdk\" >> ~\/.bash_profile java-1.8.0-openjdk.x86_64","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Cred_OS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DownloadMidServer","attrs":{"exit_status":[],"script":"echo \"from selenium import webdriver\nfrom selenium.webdriver.firefox.options import Options\nimport time\nimport os\n\noptions = Options()\noptions.headless = True\n\nprofile = webdriver.FirefoxProfile()\nprofile.set_preference('browser.download.panel.shown', False)\nprofile.set_preference('browser.download.folderList', 2)\nprofile.set_preference('browser.download.manager.showWhenStarting', False)\nprofile.set_preference('browser.download.dir', os.getcwd())\nprofile.set_preference('browser.helperApps.neverAsk.openFile', 'application\/zip')\nprofile.set_preference('browser.helperApps.neverAsk.saveToDisk', 'application\/x-gzip')\n\nbrowser = webdriver.Firefox(options=options,firefox_profile=profile)\n\nbrowser.get('https:\/\/@@{Snow_Instance}@@\/mid_server_download_ui.do')\ntime.sleep(20)\nprint('Sleep over')\nbrowser.switch_to.frame('gsft_main')\nprint('entering creds')\nusername = browser.find_element_by_id('user_name')\npassword = browser.find_element_by_id('user_password')\nusername.send_keys('admin')\npassword.send_keys('@@{AdminPassword}@@')\nlogin_attempt = browser.find_element_by_id('sysverb_login')\nlogin_attempt.click()\nprint('Password entered')\n\ntime.sleep(30)\nbrowser.switch_to.default_content()\nbrowser.switch_to.frame('gsft_main')\ndownLink = browser.find_element_by_id('linux64')\nprint('DownLink Found')\ndownLink.click()\ntime.sleep(5)\" > \/tmp\/DownloadMid.py\npython3 \/tmp\/DownloadMid.py\n\nsleep 5\n\nwhile [ true ];do if [ ! -f mid*.part ];then break;fi;done \n\nchmod 777 mid*\nmkdir -p nucalmmidser1\nmv mid* nucalmmidser1\/\ncd nucalmmidser1\nunzip mid*\nrm -f mid*.*\ncd agent\nsed -i 's\/YOUR_INSTANCE.service-now.com\/@@{Snow_Instance}@@\/g' config.xml\nsed -i 's\/YOUR_INSTANCE_USER_NAME_HERE\/nucalmuser\/g' config.xml\nsed -i 's\/YOUR_INSTANCE_PASSWORD_HERE\/@@{AdminPassword}@@\/g' config.xml\nsed -i 's\/YOUR_MIDSERVER_NAME_GOES_HERE\/nucalmmidser1\/g' config.xml\n\nsh start.sh\nsleep 30\n\necho \"Service started\"\n\necho \"from selenium import webdriver\nfrom selenium.webdriver.firefox.options import Options\nimport time\nimport os\n\noptions = Options()\noptions.headless = True\n\nprofile = webdriver.FirefoxProfile()\nprofile.set_preference('browser.download.panel.shown', False)\nprofile.set_preference('browser.download.folderList', 2)\nprofile.set_preference('browser.download.manager.showWhenStarting', False)\nprofile.set_preference('browser.download.dir', os.getcwd())\nprofile.set_preference('browser.helperApps.neverAsk.openFile', 'application\/zip')\nprofile.set_preference('browser.helperApps.neverAsk.saveToDisk', 'application\/x-gzip')\n\nbrowser = webdriver.Firefox(options=options,firefox_profile=profile)\n\nbrowser.get('https:\/\/@@{Snow_Instance}@@\/nav_to.do?uri=%2Fecc_agent.do%3Fsysparm_query=nameLIKEnucalmmidser1')\ntime.sleep(20)\nprint('Sleep over')\nbrowser.switch_to.frame('gsft_main')\nprint('entering creds')\nusername = browser.find_element_by_id('user_name')\npassword = browser.find_element_by_id('user_password')\nusername.send_keys('admin')\npassword.send_keys('\/@@{AdminPassword}@@')\nlogin_attempt = browser.find_element_by_id('sysverb_login')\nlogin_attempt.click()\nprint('Password entered')\n\ntime.sleep(20)\n\nbrowser.switch_to.default_content()\nbrowser.switch_to.frame('gsft_main')\nbrowser.execute_script('window.scrollTo(0, document.body.scrollHeight);')\nValidate_btn = browser.find_element_by_xpath('''\/\/a[text()='Validate']''')\nValidate_btn.click()\nprint('Validate Clicked')\ntime.sleep(10)\nbrowser.quit()\" > \/tmp\/ValidateMid.py\n#python3 \/tmp\/ValidateMid.py\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Cred_OS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"50e15231_runbook","main_task_local_reference":{"kind":"app_task","name":"ff04da96_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3356bccf_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"661bf580_runbook","main_task_local_reference":{"kind":"app_task","name":"3356bccf_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"CENTOS7","version":"","options":{"type":"","name":"CENTOS7","resources":{"image_type":"DISK_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"http:\/\/download.nutanix.com\/Calm\/CentOS-7-x86_64-1908.qcow2","version":{"product_version":"","type":"","product_name":""},"architecture":"X86_64","type":""},"description":""},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"b39046ae_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"environment_reference_list":[],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"Snow_Instance","value":"dev103029.service-now.com","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"AdminPassword","value":"nx2Tech100!","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"Cred_OS"},"type":"USER"},"name":"SNow Midserver"},"api_version":"3.0","metadata":{"last_update_time":"1618317113852335","kind":"blueprint","spec_version":5,"creation_time":"1611056756714494","name":"SNow Midserver"}}