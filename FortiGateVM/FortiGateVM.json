{"status":{},"contains_secrets":true,"product_version":"3.2.0","spec":{"description":"","resources":{"client_attrs":{},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"4ef32e2c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"27bc92ef_runbook","main_task_local_reference":{"kind":"app_task","name":"4ef32e2c_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5cd642c9_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"86d19083_runbook","main_task_local_reference":{"kind":"app_task","name":"5cd642c9_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"932acdf4_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"9276b0f5_runbook","main_task_local_reference":{"kind":"app_task","name":"932acdf4_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"291c93d3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"16036f9c_runbook","main_task_local_reference":{"kind":"app_task","name":"291c93d3_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"57e17329_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"01256618_runbook","main_task_local_reference":{"kind":"app_task","name":"57e17329_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service1","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get free IP"}],"name":"161525b5_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get free IP","attrs":{"exit_status":[],"script":"# region headers\n# escript-template v20190611 \/ stephane.bourdeaud@nutanix.com\n# TODO Fill in this section with your information\n# * author:     stephane.bourdeaud@nutanix.com, igor.zecevic@nutanix.com\n# * version:    v1.0\/20200129 - initial version\n# task_name:    PhpIPAMGetFreeIp\n# description:  Given a phpIPAM server ip\/fqdn, a phpIPAM app id, a token\n#               and a subnet id, return the first available IP address in \n#               that subnet. The current VM name and Calm user will be used\n#               for ip registration with ipam.               \n# outputvars:   phpipam_free_ip\n# endregion\n\n# region capture Calm variables\napi_server = \"@@{phpIPAM_address}@@\"\nphpipam_token = \"@@{phpIPAM_token}@@\"\nphpipam_app_id = \"Calm\"\nphpipam_subnet_id = \"8\"\nhostname = \"@@{name}@@\" #* this is a built-in Calm macro which returns the VM name\nowner = \"@@{calm_username}@@\" #* this is a built-in Calm macro which returns the Calm user username\n# endregion\n\n# region prepare api call\napi_server_port = \"443\"\napi_server_endpoint = \"\/api\/{}\/addresses\/first_free\/{}\".format(phpipam_app_id,phpipam_subnet_id)\nurl = \"https:\/\/{}:{}{}\".format(\n    api_server,\n    api_server_port,\n    api_server_endpoint\n)\nmethod = \"POST\"\nheaders = {\n    'Content-Type': 'application\/json',\n    'Accept': 'application\/json',\n    'token' : phpipam_token\n}\n\n# Compose the json payload\npayload = {\n    \"hostname\": hostname, \n    \"description\": hostname,\n    \"owner\": owner\n}\n# endregion\n\n# region make api call\n# make the API call and capture the results in the variable called \"resp\"\nprint(\"Making a {} API call to {}\".format(method, url))\n# ! Get rid of verify=False if you're using proper certificates\nresp = urlreq(\n    url,\n    verb=method,\n    params=json.dumps(payload),\n    headers=headers,\n    verify=False\n)\n\n# deal with the result\/response\nif resp.ok:\n    print(\"Request was successful. Status code: {}\".format(resp.status_code))\n    print (\"IP {} was registered for host {} with owner {}\".format(json.loads(resp.content)['data'],hostname,owner))\n    print('phpipam_free_ip= {}'.format(json.loads(resp.content)['data']))\n    exit(0)\nelse:\n    print(\"Request failed\")\n    print(\"Headers: {}\".format(headers))\n    print(\"Payload: {}\".format(json.dumps(payload)))\n    print('Status code: {}'.format(resp.status_code))\n    print('Response: {}'.format(json.dumps(json.loads(resp.content), indent=4)))\n    exit(1)\n# endregion\n","eval_variables":["phpipam_free_ip"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"c0e02a11_runbook","main_task_local_reference":{"kind":"app_task","name":"161525b5_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Release IP"}],"name":"4c7c9480_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"VM1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Release IP","attrs":{"expected_response_params":[{"status":"SUCCESS","code":200,"type":""}],"request_body":"","headers":[{"regex":{"should_validate":true,"value":""},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"Token","value":"@@{phpIPAM_token}@@","label":"","state":"NOT_VALIDATED","attrs":{"type":""},"editables":{},"is_hidden":false,"message_list":[],"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":true,"value":""},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"Accept","value":"application\/json","label":"","state":"NOT_VALIDATED","attrs":{"type":""},"editables":{},"is_hidden":false,"message_list":[],"options":{"type":"PREDEFINED","choices":[]}}],"url":"https:\/\/@@{phpIPAM_address}@@\/api\/Calm\/addresses\/@@{address}@@\/@@{phpIPAM_section}@@","response_paths":{},"retry_interval":1,"method":"DELETE","retry_count":1,"authentication":{"type":"none"},"tls_verify":false,"content_type":"application\/json","connection_timeout":120,"type":"HTTP","proxy_type":""},"timeout_secs":"0","type":"HTTP","variable_list":[]}],"description":"","name":"b2d604dc_runbook","main_task_local_reference":{"kind":"app_task","name":"4c7c9480_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"VM1","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":true},"os_type":"Linux","create_spec":{"name":"forti-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"64cf3bea-fc2f-4827-9ef6-fd1bce2ef86f"},"type":""},{"nic_type":"NORMAL_NIC","ip_endpoint_list":[{"ip":"@@{phpipam_free_ip}@@","type":"ASSIGNED"}],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"c594c43a-fb70-452b-8784-e9530a21f0b2"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":1,"gpu_list":[],"memory_size_mib":2048,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#this is for fgt init config file. Can only handle fgt config.\nconfig system admin\n  edit @@{forti_admin.username}@@\n    set password @@{forti_admin.secret}@@\n  next\nend\n\nconfig sys interface\n  edit port1\n    set mode dhcp\n    set ip @@{phpipam_free_ip}@@\/16\n    set allowaccess http https ssh ping telnet\n  next\n  edit port2\n    set mode static\n    set ip @@{phpipam_free_ip}@@\/16\n  next\nend\n\nconfig sys dns\n  set primary 10.200.100.1\n  unset secondary\nend\n\nconfig sys global\n  set hostname @@{name}@@\nend\n\nconfig router static\n  edit 1\n    set device port1\n    set gateway 10.200.100.1\n  next\nend\nconfig firewall addrgrp\n  edit \"Webserver\"\n    set member \"none\"\n  next\nend\n\nconfig firewall policy\n    edit 1\n        set name \"IncomingWeb\"\n        set srcintf \"port1\"\n        set dstintf \"port2\"\n        set srcaddr \"all\"\n        set dstaddr \"Webserver\"\n        set action accept\n        set schedule \"always\"\n        set service \"HTTP\" \"HTTPS\"\n    next\nend"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"8c4f7de3-544f-426d-98a2-40986fb657e4","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"LEGACY","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"fortios","uuid":"fd8ae823-9d9e-4cba-94aa-c86216154ee9"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":32768,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"xCTIdjOvyvwKi\/IxtAdAGChDB98NNAb2aapVQKqg9d9+NBj0mfjsqCx1:utf-8"},"name":"forti_admin"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service1"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c4d96a7f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0f7b7b5c_runbook","main_task_local_reference":{"kind":"app_task","name":"c4d96a7f_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"0dcbac53_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"34bfb990_runbook","main_task_local_reference":{"kind":"app_task","name":"0dcbac53_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"50a4b753_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"environment_reference_list":["8954274b-fb3d-938c-059b-d5010e0096fc"],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"phpIPAM_section","value":"8","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"phpIPAM_address","value":"10.200.100.160","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"phpIPAM_token","value":"LAubLUnRPJGCmY\/dVO8cqDKvy7aSVZTKhTzCA3wgNmP0F5iphCruomiIwL38AJqj3UMKTZNzxoiVBl6Ap4L33w==:utf-8","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"forti_admin"},"type":"USER"},"name":"FortiGateVM"},"api_version":"3.0","metadata":{"last_update_time":"1618386053833897","kind":"blueprint","spec_version":33,"creation_time":"1617794673419192","categories":{"TemplateType":"Vm"},"name":"FortiGateVM"}}