{"status":{},"contains_secrets":true,"product_version":"3.2.0","spec":{"description":"","resources":{"client_attrs":{},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"81954b2b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a75b181e_runbook","main_task_local_reference":{"kind":"app_task","name":"81954b2b_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"faedcd22_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"af413208_runbook","main_task_local_reference":{"kind":"app_task","name":"faedcd22_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"57bdf7bb_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7b5925d4_runbook","main_task_local_reference":{"kind":"app_task","name":"57bdf7bb_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"64a33564_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4c30ada9_runbook","main_task_local_reference":{"kind":"app_task","name":"64a33564_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2b4396f9_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"02e3bf4b_runbook","main_task_local_reference":{"kind":"app_task","name":"2b4396f9_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"CentOSAHV","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"editables":{"create_spec":{"resources":{"nic_list":{"0":{"subnet_reference":true}},"serial_port_list":{},"num_sockets":true,"memory_size_mib":true,"boot_config":true,"disk_list":{"0":{"device_properties":{},"disk_size_mib":true}}},"name":true,"categories":true}},"os_type":"Linux","create_spec":{"name":"@@{calm_application_name}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"64cf3bea-fc2f-4827-9ef6-fd1bce2ef86f"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nhostname: @@{name}@@\nusers:\n  - name: @@{cred_centos_password.username}@@\n    ssh-authorized-keys:\n      - @@{cred_centos_key.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nssh_pwauth: True\nchpasswd:\n  list: |\n    @@{cred_centos_password.username}@@:@@{cred_centos_password.secret}@@\n  expire: False"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"8c4f7de3-544f-426d-98a2-40986fb657e4","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS7","uuid":"c7edd112-7b4a-42db-ba9a-0df17223857e"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":{"Environment":"Dev"}},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"c1Szs5NB4r2KNR1SVsBhvwwX\/QpoI6Q0RGhPQv9Zrv8OVeUGmK8vW0O5:utf-8"},"name":"cred_centos_password"},{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"DVXFjz\/XvByk8ndQQ1r6+Tx7cpOa+EWuSmki+ZptrDdt0X4EWdAxbRz3wsjTGCKVPjeNmBJZ4p9v5Wlao4z1RqOFm8v9j5K\/CLE22\/6yaxb5MU5rSkEAftkUVw3V4nyEYH0enw91au0ms5UkvxXTu6wpcIH88eqi6AYwBmHW8L3ZQ0VrK3KDV6iHeqfrJfYbxenciiLC0s8uq7bSfxp0fR34XJ8N2A+V3wYJTQLGUxBP\/4TLlxw9xu0jl7pTsI2UM3+2ggmP7xlVNkO+s6hspX7BR\/o8ZUL7ZMUJr7V1xpc\/GT33NpfPkoPeudCP93L51FGtcP5oYI49Fr\/ZrWCps8RPx9MwUSL3ltkIO7rnPxtoy822H6E31zwJnPTgKYl4nCCzcCvHfQpZbRT0JSdDOUqlAi5mIpja+hjjfEPdCDx9bX9cfU1mk1sTuG1gzt916MlUR5hoqmwvSZaTsvmse3MGKmAfxs7E1tmOa7Xf7S57tGL0Frxa+i8H3hlP\/XJYFfVzwipT4x9weQJVMTnUZf+wLnV+FOlrxuOCz8s3QGcDHZ0lzwrK1Q22a\/n2X1GcEb1Vl166Q7NcOnASBn68rwVrgzwSiWec7fvETuHHWbWadFDtB7f5Jn8SW6JhsADNfEagKl01O38FrBzMXBrTLR2gd+hi35HNd\/awzlVlo5Ry7prya3F5vEefWPTdXewbYHKfJn4DxZ8eoql37WC6A7G2L+9tqaAulMUOrSnDO3wvPGtfOlzAajbIiVntJcPhlZ5GqMaWYFc9D00koAf4330yN7JpRDTlNA7\/CeRJRyQolc5+8JjysQmuU66pk8EsTYbWSDBez7d2iqXgYGA4bV2sxRl0euiQxZ3OErKcCujTYCH8Y+30UWjpS7yaePg4Ak0ub11A3Bf6wYs1tq03Y5jSf9gUJnRbK6tlReXEQCUhF9fFxI6e8p1eOhVPH\/llBOWJPhTlJx3j259Lvzcw0OFIVs3p\/n8FmnKtgzAeVy0AMr1Gl2z9kBEyWxXQP5pFSBIzbG1oKelekxOJmeFvDfgUnzNGG5\/+ULM+pAINlauw8JolzOfnG2sc72kxHf4eyaN8pBXW7CBa7oALDTYG58To6uwpXiGoxJZldVFR3nEIGzXBFu24iyasH8RwV4OzFEIvbGp304GFKKPU1XF81ZZKQ8sGuy8EZ4HoDQHygfXzTy\/WO89XFYGysAk07CXAbUj5MbHC2Wp8cQGA58Vhgp8OpUkh2yLPaGalAfYTHt5CdJZ\/Cxt3ldD4jDmR4wtokOSauX64Qiio8umomA3nDLfAlX+L71Z8ir4WCutzbetFkP0fM+lXv\/vVnkSg2SsSMcQaz3HfTukx3N9zXUKIwD3iYPwN3dygZlQPhAScjE5MzRn1osqszLdeTnMqI4p89WAoFWbH1AKhBtkLupFkL\/\/tqd7L6NOAeNVef3mbZLYXVNgjKVGw7\/vrHpknp0zhu5xPYi\/0ZxbOTxtU0TPSlKy17b63raVp817RRWaDaoBrfOk2y4GR2rZLPvFJKwNOQLkbga9D8HHngOXYEq4iGnVbUTFs3JOvSEK74sXoPgiatGEiEQHJv7B+d\/rjiVf2UWz8fp92jQuCRRNpCDL3DoDFeBMppVZojcNUx5JABK2SKk2ttTxJPL30CsDEc9Jya9MP4Lrm86DxmTPoETcaaCXP6V8VcDBfX+ubhyOMM4Ot+J5QZ5im6qdL5jHGn4ezjP2KN\/2kgU2Qz7\/BJ\/pYqwe1ruYTDTZ3i9Bkawwyeqidmd+GBoVfNq99v7fU69MvBQAI8Y\/sa1lr0Zo0lvc02Zhq+W4MkpPNyYpS9kbkUc1hVqwaBJXrnjAzvELhT9mJXtYGjn2I0FK61Q\/+q5c4sfCdJ5jcOyrI0NYaeWqM8mkyhxhoSmUSSTxL8loxA7yEmK9AHbGPCEjtX7jPjnplcqFH9tU7eIqMeXhjNwM2Gip+aOZPG\/o85mn6HJvCYYU6v\/Bfc\/p73BryTfC3nSc3Y76trUCJkhF3xhYi7v5XT+EUA\/W5HUsWIwnmI5FGP0Xfaq1ZRhdsUayXbGrCCDEkd6KR2Dzjwj5gEkl4vO9hdoipPCrUDzs+RRs3Jd4XWa17RXlaDAjY\/3xVoKPq+WIufhi+1SbQPio42eocjjP0iG2TxEympC69YGkfFSniG2MSqPlm6SNFWJXhtQLYApd5QhqQFK4FP0eHywTXUsMflWw59R8F2Yf2qLAagEPyvwQOUvyKg\/AoNdiSy8IPapI3pEJ9YIk6oFriBxjZGH99:utf-8"},"name":"cred_centos_key"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service"}],"name":"Package","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Terraform"},{"kind":"app_task","name":"Create Endpoint"}],"name":"ec057e77_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Install Terraform"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Endpoint"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Terraform","attrs":{"script":"sudo yum update -y\nsudo yum install -y wget unzip git\n\nTER_VER=`curl -s https:\/\/api.github.com\/repos\/hashicorp\/terraform\/releases\/latest |  grep tag_name | cut -d: -f2 | tr -d \\\"\\,\\v | awk '{$1=$1};1'`\nwget https:\/\/releases.hashicorp.com\/terraform\/${TER_VER}\/terraform_${TER_VER}_linux_amd64.zip\n\nunzip terraform_${TER_VER}_linux_amd64.zip\nsudo mv terraform \/usr\/local\/bin\/\n\nrm terraform_${TER_VER}_linux_amd64.zip\n\nterraform version\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Endpoint","attrs":{"exit_status":[],"script":"# script\n\n# modify these if required\ncred_user = \"@@{cred_centos_password.username}@@\"\ntype = \"Linux\"\n\njwt = \"@@{calm_jwt}@@\"\nvm_ip = \"@@{address}@@\"\nblueprint_id = \"@@{calm_blueprint_uuid}@@\"\n\nbase_url = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/'\n\ndef put_call(api_url, payload):\n  headers = { 'Content-Type' : 'application\/json', 'Accept':'application\/json', 'Authorization': 'Bearer {}'.format(jwt) }\n  r = urlreq(api_url, verb='PUT', params=payload, headers=headers, verify=False)\n  resp = json.loads(r.content)\n  if \"status\" in resp:\n    return resp\n  else:\n    print \"Post request failed\", r.content\n    exit(1)\n    \n\ndef post_call(api_url, payload):\n  headers = { 'Content-Type' : 'application\/json', 'Accept':'application\/json', 'Authorization': 'Bearer {}'.format(jwt) }\n  r = urlreq(api_url, verb='POST', params=payload, headers=headers, verify=False)\n  resp = json.loads(r.content)\n  if \"status\" in resp:\n    return resp\n  else:\n    print \"Post request failed\", r.content\n    exit(1)\n    \n    \ndef get_call(api_url):\n  headers = { 'Authorization': 'Bearer {}'.format(jwt) }\n  r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n  resp = json.loads(r.content)\n  if \"status\" in resp:\n    return resp\n  else:\n    print \"Post request failed\", r.content\n    exit(1)\n\n\napi_url = base_url + \"blueprints\/\" + '@@{calm_blueprint_uuid}@@'\nblueprint = get_call(api_url)\n\nproject_id = blueprint[\"metadata\"][\"project_reference\"][\"uuid\"]\nproject_name = blueprint[\"metadata\"][\"project_reference\"][\"name\"]\n\napi_url = base_url + \"endpoints\/import_json\"\n\nendpoint_json = {\n  \"spec\": {\n    \"name\": \"Endpoint_@@{name}@@\",\n    \"description\": \"Endpoint for vm @@{name}@@\",\n    \"resources\": {\n      \"name\": \"Endpoint_@@{name}@@\",\n      \"type\": type,\n      \"attrs\": {\n        \"values\": [ \"@@{address}@@\" ],\n        \"value_type\": \"IP\",\n        \"port\": 22,\n        \"credential_definition_list\": [\n          {\n            \"name\": \"endpoint_cred\",\n            \"description\": cred_user,\n            \"type\": \"KEY\",\n            \"username\": cred_user,\n            \"secret\": {\n              \"attrs\": {\n                \"is_secret_modified\": False\n              }\n            }\n          }\n        ],\n        \"login_credential_reference\": {\n          \"kind\": \"app_credential\",\n          \"name\": \"endpoint_cred\"\n        }\n      }\n    }\n  },\n  \"metadata\": {\n    \"spec_version\": 1,\n    \"name\": \"Endpoint_@@{name}@@\",\n    \"kind\": \"endpoint\",\n    \"project_reference\": {\n      \"kind\": \"project\",\n      \"uuid\": project_id,\n      \"name\": project_name\n    }\n  },\n  \"api_version\": \"3.0\"\n}\n\nendpoint_return = post_call(api_url, json.dumps(endpoint_json))\n\napi_url = base_url + \"endpoints\/\" + endpoint_return[\"metadata\"][\"uuid\"]\nendpoint = get_call(api_url)\n\ndel endpoint[\"status\"]\nendpoint[\"spec\"][\"resources\"][\"attrs\"][\"credential_definition_list\"][0][\"secret\"][\"value\"] = \"\"\"@@{cred_centos_password.secret}@@\"\"\"\nendpoint[\"spec\"][\"resources\"][\"attrs\"][\"credential_definition_list\"][0][\"secret\"][\"attrs\"][\"is_secret_modified\"] = True \n\nendpoint_update = put_call(api_url, json.dumps(endpoint))\n\nprint \"endpoint_uuid=\"+endpoint_return[\"metadata\"][\"uuid\"]\n\n","eval_variables":["endpoint_uuid"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"d5937ba4_runbook","main_task_local_reference":{"kind":"app_task","name":"ec057e77_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Remove Endpoint"}],"name":"c0836db3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove Endpoint","attrs":{"script":"# script\njwt = \"@@{calm_jwt}@@\"\nvm_ip = \"@@{address}@@\"\nblueprint_id = \"@@{calm_blueprint_uuid}@@\"\n\nbase_url = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/'\n  \ndef delete_call(api_url):\n  headers = { 'Authorization': 'Bearer {}'.format(jwt) }\n  r = urlreq(api_url, verb='DELETE', headers=headers, verify=False)\n  resp = json.loads(r.content)\n  return resp\n\napi_url = base_url + \"endpoints\/@@{endpoint_uuid}@@\"\ndelete_call(api_url)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"7dd04fa4_runbook","main_task_local_reference":{"kind":"app_task","name":"c0836db3_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"89a88d1e_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package"}],"substrate_local_reference":{"kind":"app_substrate","name":"CentOSAHV"},"variable_list":[],"description":""}],"environment_reference_list":[],"description":"","action_list":[],"name":"Default","variable_list":[]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"cred_centos_password"},"type":"USER"},"name":"TerraformHost"},"api_version":"3.0","metadata":{"last_update_time":"1613666258532367","kind":"blueprint","spec_version":3,"creation_time":"1610434880654581","categories":{"TemplateType":"Vm"},"name":"TerraformHost"}}