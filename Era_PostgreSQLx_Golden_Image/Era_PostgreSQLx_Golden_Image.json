{"status":{},"contains_secrets":true,"product_version":"3.2.0","spec":{"description":"Based on https:\/\/confluence.eng.nutanix.com:8443\/pages\/viewpage.action?pageId=77381421\nCustom Action for registering Database VM and create Software Profile\nNeeds Centos7 Image like https:\/\/cloud.centos.org\/centos\/7\/images\/CentOS-7-x86_64-GenericCloud-2009.qcow2","resources":{"client_attrs":{},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9e528ee4_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0b82b349_runbook","main_task_local_reference":{"kind":"app_task","name":"9e528ee4_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f1d1a964_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"859f1e11_runbook","main_task_local_reference":{"kind":"app_task","name":"f1d1a964_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9e199c52_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"99014a15_runbook","main_task_local_reference":{"kind":"app_task","name":"9e199c52_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"71475cc0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"62e96f14_runbook","main_task_local_reference":{"kind":"app_task","name":"71475cc0_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"aaad1342_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"b27e0abe_runbook","main_task_local_reference":{"kind":"app_task","name":"aaad1342_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service1","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"pg12","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"pg12-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"64cf3bea-fc2f-4827-9ef6-fd1bce2ef86f"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":4,"gpu_list":[],"memory_size_mib":16384,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nhostname: @@{name}@@\nusers:\n  - name: @@{cred_centos_key.username}@@\n    ssh-authorized-keys:\n      - @@{cred_centos_key.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\n  - name: @@{cred_era_password.username}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\n  - name: postgres\n    \nssh_pwauth: True\nchpasswd:\n  list: |\n    @@{cred_era_password.username}@@:@@{cred_era_password.secret}@@\n  expire: False"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"8c4f7de3-544f-426d-98a2-40986fb657e4","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS7","uuid":"c7edd112-7b4a-42db-ba9a-0df17223857e"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"era","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"idaI6mmkMhKChtnIgy4gbfubwerxeg\/JYi5PhsNhbcO5+dGx2ONjYe0=:utf-8"},"name":"cred_era_password"},{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"ho6iecck\/b02U8lSclJHIkRDnbDBE9Kn7gPA08c9ygilkHj0jofa9vYcOjvITcu3E+a++w0o6m96+MZ9Tk0rBytAN9OJj7JccIh0Cekp5MBxwwSi6RpQZj4bY0E7Rb3wUD832fTdKUvI1M5kEqIM\/g+atNcQbFJXTIsMbb43AMKzuE9lQbqwZX\/Wfeq9whjVfts4NwVoTWrIUOxQ7HtI260zZ0tNjaifTsc0XVNYO9dpVuIYSv2WjffpulVn4NkB8P4wInEdWSLN4bMU2cmuoj824kaIuLemvF7AhrVj4zrb8bIrowZX1ZHy5YklJe6S+o6g+A1tiagW+b7pUL6e141fL\/bnOKMBCvRBfHzp5cLTIV4J4N91IkPhNGUuoYDmsWqQ3TSC6FaA\/HmAhPqc+I+nroLpAzhNUJoQfahdf3MW6Ai1jGsBiduYazXzA7avbqECqYH2fBZhsCqTBRljFN+PjcAAAB5+dEQIIBWgTjCZcSxz2Y+k4BhZdfAboRdz0d9lhAmFw4HE7TGIKyQFnHj3WS5+9WmJhapVAYtVOsesDiRzW00c5z0W12p9BvS2BI\/iHrweSDmrlAv+jiiew7lkldczBUp\/IWq5OjwFx7JPaGEpCKthb+zT8lN7G93404R3YxpZiEqVl3ezeGTZ+5ZwcrgngQTfjZEktege1micY+CVqFb2gbY1glEqxDezZy17FCUgyTtaQV2QDARxZkBrFigWS4o7HE0\/t6fczZUA1GOToOWe\/panFFp5Bqo\/HcBK5R1DwsY\/YZhVb1lWGlZ6hF\/qmfIgWUIcz0Bi00XlZ1PFiDrJ4ozG2rKW8WJx61fKJDss8oC7L1v2WlRppqX7YLHc2ZgupCAHAAOwR5sLchleQ9bZ6eVxkNGEHKOcdETul89L7s\/3+7hNDqR\/yhkrU\/AL45w061cSIrL6e6FoWFEo7lcqHAqJ7ctSkhU+cI6+Fnuau\/T+ZpCq1GiKsNM3PBq5xplxLY4mmQ6\/JvfCrLTtnq4fdRugCbFoIQrx6rzlIjyqdRHOKHXCKX3HtRLXgubm2TMw8uj+Vod9Pk5+qayzvJFVcQNLx+T+oXWB6CG87wpsV4wjBHVmTSuyJdr2wu\/Nry83yQVJyr2CF3tjNgK4DX35AF6a8QUQDlB+ZltgbCYzbI+YjiFT8QvfuxW2Xr2m4B0IjPMEjkMy3r1RopRbDruInH\/D6Rc2mQNMS4axCO0pV9PjJNzvppPj4\/nxIKbJYeSa7L46QIkKnUa4G2L+YeKsU2Q1U1VPdUM3UEnv2WFautsRpkuVQXGTqd18pen9BZ7bOaf\/jQqyzKyICNJTkEpkHpblyjbPxjA2SOQOa1oCaYj9nz6Uf8RMBxJNYNPpo21iqj41Po4pbUvllQFl0KsRaPooKKNq9NujYsnPqWAJSqgHW662xJzSyd9WmN6eQr+oSJTY78xGxhiVBzvEH6ZNl71OElbzv4oly9cnWVFxjemeZxH3vAKglOGoL5vVZpJ8w8pKAH205Zur3Cl\/FJW1toQUudiVTAUFpASk0GHXpmX2dEeTkfgEKfs1Xdtx4srhZIZEa5aiBRHRr5PDF84+yriBjTc7cWuYhB\/FQke0Kbzpy1eA40bHmpsPunGJmPnfFLJ6OdD+Iho69hDVEwEXx2R0aQP8Q7EqXT6Tjhco1NP0LoAu+rTjGHajQA\/Plx5q1ZUDMKjCDk2Cr6niAKuS33+6EYoo0chstMg4PmWxQyBcZklb+qF8qzjpcQRPVRavE+lR1VrM4SUEO+hJRKHVViJVNr0s15zLX0wBshwqt\/A90jToDNePQ1AoHMA5FGIrEluteyjBx3UNld0\/d68bbnwGgskycgGSex\/Wk+OEaUHWccp7j8WfPezn6YvNQ5DJizlpaoCeoOlxIDCqO0rXXBlm9u4MHtjxDzu7fyBfH9phSWzX6GNu7qxJsB4T1evNnGuej2ZcevHVhgbp62Yxyp+BpDtUuwl6PudsXYm8OwBRFIc7Gb5dx6NZn2Qr\/gWm684H2RsAwGC2SFO11lZBxLZAjp7ZAKaNbClCBw5NpYbw1yhdnLPoFnXG9ES5Wo82JzrPwVT5yQCce80TyxgwBrw+6GtINPMroKjhQYjTyGCHJKcflegJVIQSQx0oFBkgpva3lEQplDizX1Ldrhzo13j3FhqcCEC43VVbiytrtnzQvHlNjrE999s7nG6K\/v88FlIUN98hEuZDum9XrKczZf6SR2g3VSOh6qPstQ++wPFmAqtCM8+dlQQQOKkbnGsiyxFC9TRX:utf-8"},"name":"cred_centos_key"},{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"G8k2nM\/bMN+rCZivzZw2F\/kAjwxKsmbuc9hYwVyazAmld1S1liJCFy8+eA==:utf-8"},"name":"cred_era_admin_password"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service1"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"1_update_yum"},{"kind":"app_task","name":"2_update_pip_epel"},{"kind":"app_task","name":"3_dependency_packages"},{"kind":"app_task","name":"4_haproxy_install"},{"kind":"app_task","name":"5_pre_reqs_patroni_pg"},{"kind":"app_task","name":"edit_postgre_bashrc"},{"kind":"app_task","name":"6_patroni_install"},{"kind":"app_task","name":"7_etcd_installation"},{"kind":"app_task","name":"8_keepalive_install"},{"kind":"app_task","name":"show_versions"}],"name":"81a41d21_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"1_update_yum"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"2_update_pip_epel"}},{"from_task_reference":{"kind":"app_task","name":"2_update_pip_epel"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"3_dependency_packages"}},{"from_task_reference":{"kind":"app_task","name":"3_dependency_packages"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"4_haproxy_install"}},{"from_task_reference":{"kind":"app_task","name":"4_haproxy_install"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"5_pre_reqs_patroni_pg"}},{"from_task_reference":{"kind":"app_task","name":"6_patroni_install"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"7_etcd_installation"}},{"from_task_reference":{"kind":"app_task","name":"7_etcd_installation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"8_keepalive_install"}},{"from_task_reference":{"kind":"app_task","name":"8_keepalive_install"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"show_versions"}},{"from_task_reference":{"kind":"app_task","name":"5_pre_reqs_patroni_pg"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"edit_postgre_bashrc"}},{"from_task_reference":{"kind":"app_task","name":"edit_postgre_bashrc"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"6_patroni_install"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1_update_yum","attrs":{"exit_status":[],"script":"sudo yum -y update","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2_update_pip_epel","attrs":{"exit_status":[],"script":"sudo yum -y install epel-release\n\n#After install Please verify the version (min 7.11)\nyum info epel-release\n\n#pip Install\n \nsudo yum -y install python-pip\n \nsudo pip install --upgrade \"pip < 21\"\n\n#Check pip version (min 19.01) \npip --version","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3_dependency_packages","attrs":{"exit_status":[],"script":"sudo yum -y install wget\nsudo yum -y install zip\nsudo yum -y install unzip\nsudo yum -y install curl\nsudo yum -y install net-tools\nsudo yum -y install readline-devel zlib-devel\nsudo yum -y install gcc\nsudo yum -y install centos-release-scl-rh\nsudo yum -y install rsync ntp ntpdate\nsudo yum -y install lvm2","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"4_haproxy_install","attrs":{"exit_status":[],"script":"sudo yum -y install haproxy\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5_pre_reqs_patroni_pg","attrs":{"exit_status":[],"script":"sudo yum install -y python-devel\nsudo yum install -y python3-devel\n\nsudo yum install --downloadonly --downloaddir=. iptables-services\nsudo rpm -ivh iptables-services-1.4.21-35.el7.x86_64.rpm\nsudo systemctl start iptables\nsudo ln -s \/usr\/local\/bin\/patroni \/usr\/bin\/patroni \n\n\n# Install the repository RPM:\nsudo yum install -y https:\/\/download.postgresql.org\/pub\/repos\/yum\/reporpms\/EL-7-x86_64\/pgdg-redhat-repo-latest.noarch.rpm\n\n# Install PostgreSQL:\n# Small fix for 9.6 Path and 96 Package\nversion=\"@@{postgre_version}@@\"\nsudo yum install -y postgresql${version\/\/.\/}-devel\nsudo yum install -y postgresql${version\/\/.\/}-server\nsudo yum install -y postgresql-libs\n\nsudo pip3 install psycopg2-binary\nsudo pip install urllib3==1.24.2","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"edit_postgre_bashrc","attrs":{"exit_status":[],"script":"echo '# User specific aliases and functions\nLC_ALL=\"en_US.UTF-8\"\nLC_CTYPE=\"en_US.UTF-8\"\nexport LC_ALL\nexport LC_CTYPE\nexport PGHOST=localhost' | sudo tee -a \/home\/postgres\/.bashrc","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6_patroni_install","attrs":{"exit_status":[],"script":"pip install -U setuptools\n\nsudo pip3 install patroni[etcd]==1.6.4","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7_etcd_installation","attrs":{"exit_status":[],"script":"#pip based installation\nsudo pip install etcd3==0.10.0\n \npip show etcd3\n\netcd --version\n\n# rpm install\nwget https:\/\/rpmfind.net\/linux\/centos\/7\/extras\/x86_64\/Packages\/etcd-3.3.11-2.el7.centos.x86_64.rpm\n \nsudo rpm -i etcd-3.3.11-2.el7.centos.x86_64.rpm\n\netcd --version","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8_keepalive_install","attrs":{"exit_status":[],"script":"#dependency package\nsudo yum -y install iptables-services\n#as iptables are used by keepalive\n \nsudo yum -y install keepalived\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"show_versions","attrs":{"exit_status":[],"script":"echo haproxy\nyum info haproxy\necho ----\necho patroni\npip3 show patroni\necho ----\necho etcd\npip show etcd3\netcd --version\necho ----\necho keepalived\nsudo keepalived --version","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_centos_key"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"9dac9767_runbook","main_task_local_reference":{"kind":"app_task","name":"81a41d21_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"delete_registered_databasevm"},{"kind":"app_task","name":"MonitorDeleteDatabaseVM"}],"name":"2cd61fd9_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"delete_registered_databasevm"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"MonitorDeleteDatabaseVM"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"delete_registered_databasevm","attrs":{"exit_status":[],"script":"import requests\n# Set creds and headers\nera_user = \"@@{cred_era_admin_password.username}@@\"\nera_pass = \"@@{cred_era_admin_password.secret}@@\"\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\neracleanupdbvmurl = \"https:\/\/@@{era_ip}@@\/era\/v0.9\/dbservers\/@@{SOURCE_DBSERVER_ID}@@\"\n# Set headers\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n# Define payload\npayload = json.dumps({\n    \"softRemove\": False,\n    \"remove\": True,\n    \"delete\": False,\n    \"deleteVgs\": True,\n    \"deleteVmSnapshots\": True\n})\n#\nresp = requests.delete(\n    eracleanupdbvmurl,\n    headers=headers,\n    auth=(era_user, era_pass),\n    data= payload,\n    verify=False\n)\n\n\nif resp.ok:\n    print(\"DeleteOperationId={0}\".format(json.loads(resp.content)[0][\"operationId\"]))\nelse:\n    print(\n        \"Delete DatabaseVM failed\", json.dumps(json.loads(resp.content), indent=4)\n    )\n    exit(1)\n","eval_variables":["DeleteOperationId"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MonitorDeleteDatabaseVM","attrs":{"script":"# Set creds, headers, and URL\nera_user = '@@{cred_era_admin_password.username}@@'\nera_pass = '@@{cred_era_admin_password.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@\/era\/v0.9\/operations\/@@{DeleteOperationId}@@\"\nprint \"Monitoring Delete DatabaseVM Operation...\"\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 60 seconds.\"\n  sleep(60)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break\n\n# If the operation did not complete within 20 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Get Operation ID timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"20fc92c6_runbook","main_task_local_reference":{"kind":"app_task","name":"2cd61fd9_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"9616d505_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"pg12"},"variable_list":[],"description":""}],"environment_reference_list":[],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"GetEraDetails"},{"kind":"app_task","name":"Register Golden Image"},{"kind":"app_task","name":"MonitorRegisterDBVM"},{"kind":"app_task","name":"CreateSoftwareProfile"},{"kind":"app_task","name":"MonitorCreateProfile"}],"name":"e1bb1bd4_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"GetEraDetails"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Register Golden Image"}},{"from_task_reference":{"kind":"app_task","name":"Register Golden Image"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"MonitorRegisterDBVM"}},{"from_task_reference":{"kind":"app_task","name":"MonitorRegisterDBVM"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"CreateSoftwareProfile"}},{"from_task_reference":{"kind":"app_task","name":"CreateSoftwareProfile"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"MonitorCreateProfile"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"GetEraDetails","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = \"@@{cred_era_admin_password.username}@@\"\nera_pass = \"@@{cred_era_admin_password.secret}@@\"\nheaders = {\"Content-Type\": \"application\/json\", \"Accept\": \"application\/json\"}\n\n# Get Cluster ID\nurl = \"https:\/\/@@{era_ip}@@\/era\/v0.9\/clusters\"\nresp = urlreq(\n    url, verb=\"GET\", auth=\"BASIC\", user=era_user, passwd=era_pass, headers=headers\n)\nif resp.ok:\n    print(\"CLUSTER_ID={0}\".format(json.loads(resp.content)[0][\"id\"]))\nelse:\n    print(\n        \"Get Cluster ID request failed\", json.dumps(json.loads(resp.content), indent=4)\n    )\n    exit(1)","eval_variables":["CLUSTER_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register Golden Image","attrs":{"exit_status":[],"script":" # Set creds and headers\nera_user = '@@{cred_era_admin_password.username}@@'\nera_pass = '@@{cred_era_admin_password.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nprint \"Monitoring Register DatabaseVM Operation...\"\n\n# Set the URL and payload\nurl     = \"https:\/\/@@{era_ip}@@\/era\/v0.9\/dbservers\/register\"\npayload = {\n  \"actionArguments\": [\n    {\n      \"name\": \"listener_port\",\n      \"value\": \"5432\"\n    },\n    {\n      \"name\": \"postgres_software_home\",\n      \"value\": \"\/usr\/pgsql-@@{postgre_version}@@\"\n    }\n  ],\n  \"vmIp\": \"@@{address}@@\",\n  \"nxClusterUuid\": \"@@{CLUSTER_ID}@@\",\n  \"databaseType\": \"postgres_database\",\n  \"forcedInstall\": \"true\",\n  \"workingDirectory\": \"\/tmp\",\n  \"username\": \"@@{cred_era_password.username}@@\",\n  \"password\": \"@@{cred_era_password.secret}@@\"\n}\n\n# Make the call and set the response operation ID to the variable\nresp = urlreq(url, verb='POST', auth='BASIC', user=era_user, passwd=era_pass, params=json.dumps(payload), headers=headers)\nif resp.ok:\n  print \"REGISTER_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\nelse:\n  print \"Database VM Register failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["REGISTER_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MonitorRegisterDBVM","attrs":{"exit_status":[],"script":"# Set creds, headers, and URL\nera_user = '@@{cred_era_admin_password.username}@@'\nera_pass = '@@{cred_era_admin_password.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@\/era\/v0.9\/operations\/@@{REGISTER_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 60 seconds.\"\n  sleep(60)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break\n\n# If the operation did not complete within 20 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Get Operation ID timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# Get the newly provision DB Entity Name and set it to a variable\nprint \"SOURCE_DBSERVER_ID={0}\".format(json.loads(resp.content)['entityId'])","eval_variables":["SOURCE_DBSERVER_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CreateSoftwareProfile","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{cred_era_admin_password.username}@@'\nera_pass = '@@{cred_era_admin_password.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nprint \"Monitoring Create Software Profile Operation...\"\n\n# Set the URL and payload\nurl     = \"https:\/\/@@{era_ip}@@\/era\/v0.9\/profiles\"\npayload = {\n  \"engineType\": \"postgres_database\",\n  \"type\": \"Software\",\n  \"topology\": \"single\",\n  \"dbVersion\": \"ALL\",\n  \"systemProfile\": \"false\",\n  \"properties\": [\n    {\n      \"name\": \"SOURCE_DBSERVER_ID\",\n      \"value\": \"@@{SOURCE_DBSERVER_ID}@@\",\n      \"secure\": \"false\",\n      \"description\": \"ID of the database server that should be used as a reference to create the software profile\"\n    },\n    {\n      \"name\": \"BASE_PROFILE_VERSION_NAME\",\n      \"value\": \"Postgres @@{postgre_version}@@ by Calm Blueprint\",\n      \"secure\": \"false\",\n      \"description\": \"Name of the base profile version.\"\n    },\n    {\n      \"name\": \"BASE_PROFILE_VERSION_DESCRIPTION\",\n      \"value\": \"Deployed by Calm @@{calm_application_name}@@\",\n      \"secure\": \"false\",\n      \"description\": \"Description of the base profile version.\"\n    },\n    {\n      \"name\": \"OS_NOTES\",\n      \"value\": \"\",\n      \"secure\": \"false\",\n      \"description\": \"Notes or description for the Operating System.\"\n    },\n    {\n      \"name\": \"DB_SOFTWARE_NOTES\",\n      \"value\": \"\",\n      \"secure\": \"false\",\n      \"description\": \"Description of the Postgres database software.\"\n    }\n  ],\n  \"availableClusterIds\": [\n    \"@@{CLUSTER_ID}@@\"\n  ],\n  \"name\": \"@@{calm_application_name}@@\"\n}\n\n# Make the call and set the response operation ID to the variable\nresp = urlreq(url, verb='POST', auth='BASIC', user=era_user, passwd=era_pass, params=json.dumps(payload), headers=headers)\nif resp.ok:\n  print \"CREATEPROFILE_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])\nelse:\n  print \"Create Profile failed\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)","eval_variables":["CREATEPROFILE_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MonitorCreateProfile","attrs":{"script":"# Set creds, headers, and URL\nera_user = '@@{cred_era_admin_password.username}@@'\nera_pass = '@@{cred_era_admin_password.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{CREATEPROFILE_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 60 seconds.\"\n  sleep(60)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break\n\n# If the operation did not complete within 20 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  print \"Get Operation ID timed out\", json.dumps(json.loads(resp.content), indent=4)\n  exit(1)\n\n# Get the newly provision DB Entity Name and set it to a variable\n#print \"CLONE_ENTITY_NAME={0}\".format(json.loads(resp.content)['entityName'])\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"ff45f854_runbook","main_task_local_reference":{"kind":"app_task","name":"e1bb1bd4_dag"},"variable_list":[]},"name":"Register Golden Image"}],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"era_ip","value":"10.200.100.40","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"postgre_version","value":"12","label":"PostGreSQL Version","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["9.6","10","11","12"]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"cred_era_password"},"type":"USER"},"name":"Era PostgreSQLx Golden Image"},"api_version":"3.0","metadata":{"last_update_time":"1613666258551605","kind":"blueprint","spec_version":23,"creation_time":"1610434832560748","categories":{"TemplateType":"Vm"},"name":"Era PostgreSQLx Golden Image"}}